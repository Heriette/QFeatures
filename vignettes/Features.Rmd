---
title: "Quantitative features for mass spectrometry data"
author:
- name: Laurent Gatto
package: Features
abstract: >
 This vignette describes the functionality implemented in the Features
 package. Features provides infrastructure to manage and process
 quantitative features for high-throughput mass spectrometry assays,
 including proteomics and metabolomics.
output:
  BiocStyle::html_document:
    toc_float: true
bibliography: Features.bib
vignette: >
  %\VignetteIndexEntry{Quantitative features for mass spectrometry data}
  %\VignetteEngine{knitr::rmarkdown}
  %%\VignetteKeywords{Mass Spectrometry, MS, MSMS, Proteomics, Metabolomics, Infrastructure, Quantitative }
  %\VignetteEncoding{UTF-8}
---

```{r style, echo = FALSE, results = 'asis'}
BiocStyle::markdown()
```

# Introduction

The `Features` package provides infrastructure (that is classes and
the methods to process and manipulate them) to manage and analyse
quantitative features from mass spectrometry experiments. It is based
on the `MultiAssayExperiment` class that stores a set of
assays. Assays in a `Features` object have a specific relation, that
is depicted in figure \@ref(fig:featuresplot): assays in a `Features`
object are the result of the aggregation of quantitative features of
other assays. In the case of a quantitative proteomics experiment,
these different assays would be PSMs, that are aggregated into
peptides, that are themselves aggregated into proteins. 

```{r featuresplot, fig.wide = TRUE, fig.cap = "Conceptual representation of a `Features` object and the relation between different assays.", echo = FALSE}
par(mar = c(0, 0, 0, 0))
plot(NA, xlim = c(0, 12), ylim = c(0, 20),
     xaxt = "n", yaxt = "n",
     xlab = "", ylab = "", bty = "n")

for (i in 0:7) 
    rect(0, i, 3, i+1, col = "lightgrey", border = "white")


for (i in 8:12) 
    rect(0, i, 3, i+1, col = "steelblue", border = "white")

for (i in 13:18) 
    rect(0, i, 3, i+1, col = "orange", border = "white")

for (i in 19) 
    rect(0, i, 3, i+1, col = "darkgrey", border = "white")


for (i in 5:7) 
    rect(5, i, 8, i+1, col = "lightgrey", border = "white")

for (i in 8:10) 
    rect(5, i, 8, i+1, col = "steelblue", border = "white")

for (i in 11:13) 
    rect(5, i, 8, i+1, col = "orange", border = "white")

for (i in 14) 
    rect(5, i, 8, i+1, col = "darkgrey", border = "white")

rect(9, 8, 12, 8+1, col = "lightgrey", border = "white")
rect(9, 9, 12, 9+1, col = "steelblue", border = "white")
rect(9, 10, 12, 10+1, col = "orange", border = "white")
rect(9, 11, 12, 11+1, col = "darkgrey", border = "white")

segments(3, 8, 5, 8, lty = "dashed")
segments(3, 6, 5, 7, lty = "dashed")
segments(3, 4, 5, 6, lty = "dashed")
segments(3, 0, 5, 5, lty = "dashed")

segments(3, 10, 5, 9, lty = "dashed")
segments(3, 11, 5, 10, lty = "dashed")
segments(3, 13, 5, 11, lty = "dashed")

segments(3, 14, 5, 12, lty = "dashed")
segments(3, 16, 5, 13, lty = "dashed")
segments(3, 19, 5, 14, lty = "dashed")

segments(3, 20, 5, 15, lty = "dashed")


segments(8, 5, 9, 8, lty = "dashed")
segments(8, 8, 9, 9, lty = "dashed")
segments(8, 11, 9, 10, lty = "dashed")
segments(8, 14, 9, 11, lty = "dashed")
segments(8, 15, 9, 12, lty = "dashed")
```

In the following sections, we are going to demonstrate how to create a
single-assay `Features` objects starting from a spreadsheet, how to
compute the next assays (peptides and proteins), and how these can be
manipulated and explored.

# Creating Features object

```{r loaddfr, echo = FALSE}
data(hlpsms)
```

While `Features` objects can be created manually (see `?Features` for
details), most users will probably possess quantitative data in a
spreadsheet or a dataframe. In such cases, the easiest is to use the
`readFeatures` function to extract the quantitative data and metadata
columns. Below, we load the `hlpsms` dataframe that contains data for 
`r ncol(hlpsms)` PSMs from the TMT-10plex *hyper*LOPIT spatial proteomics experiment
from [@Christoforou:2016]. The `ecol` argument specifies that columns
1 to 10 contain quantitation data, and that the assay should be named
`psms` in the returned `Features` object, to reflect the nature of the
data.


```{r readFeatures}
data(hlpsms)
hl <- readFeatures(hlpsms, ecol = 1:10, name = "psms")
hl
```

Below, we see that we can extract an assay using its index or its
name. The individual assays are stored as *SummerizedExperiment*
object and further access its quantitative data and metadata using
the `assay` and `rowData` functions



```{r}
hl[[1]]
hl[["psms"]]
head(assay(hl[["psms"]]))
head(rowData(hl[["psms"]]))
```

For further details on how to manipulate such objects, refer to the
*MultiAssayExperiment* and *SummerizedExperiment* package.


On

```{r}
## ----------------------------------------------------
## Add new assays, computed from the existing ones (see
## ?combineFeatures for details)
## ----------------------------------------------------

hl <- combineFeatures(hl, "psms", "Sequence", name = "peptides")
hl
hl <- combineFeatures(hl, "peptides", "ProteinGroupAccessions", name = "proteins")
hl
```

# Subsetting 


One particularity of 

```{r}
## ----------------------------------------------------------------
## Extract a subset of features that relate to Isoform Stat3B of
## Signal transducer and activator of transcription 3 (STAT3) with
## accession number P42227-2
## ----------------------------------------------------------------
stat3 <- hl["P42227-2", , ]
## we get one protein, 8 peptides and 9 PSMs
stat3
stat3_df <- data.frame(longFormat(stat3))
library("ggplot2")
ggplot(data = stat3_df,
       aes(x = colname,
           y = value,
           group = rowname)) +
    geom_line() +
    facet_grid(~ assay)
## --------------------------------------------------------------
## Extract Signal transducer and activator of transcription 1
## (STAT1) and 3 (STAT3) (accession numbers P42227-2 and P42225)
## --------------------------------------------------------------
stat <- hl[c("P42227-2", "P42225"), , ]
## STAT1 has only one peptide/PSM
stat
stat_df <- data.frame(longFormat(stat))
stat_df$stat3 <- ifelse(stat_df$rowname %in% stat3_df$rowname,
                        "STAT3", "STAT1")
ggplot(data = stat_df,
       aes(x = colname,
           y = value,
           group = rowname)) +
    geom_line() +
    facet_grid(stat3 ~ assay)
## --------------------------------------------------------------
## Subsetting by features using pipes (same example as above)
## --------------------------------------------------------------
library(magrittr)
hl %>% subsetByFeature("P42227-2")
hl %>% subsetByFeature(c("P42227-2", "P42225"))

## --------------------------------------------------------------
## Interactively explore the data
## --------------------------------------------------------------
## if (interactive())
##     display(stat3)
```

# Filtering



# Session information {-}

```{r sessioninfo, echo=FALSE}
sessionInfo()
```


# References {-}
